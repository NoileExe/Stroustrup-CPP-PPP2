// –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏–∑ 10–æ–π –≥–ª–∞–≤—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –¥–ª—è –ø–æ–±–∏—Ç–æ–≤—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
/*
 * Token_stream —Ç–µ–ø–µ—Ä—å –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–º –∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ —Ñ-—Ü–∏–∏ calculate() —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ—Ç–æ–∫–∞ –≤–≤–æ–¥–∞ 
 * 		–≤ –∫–∞—á–µ—Å—Ç–≤–µ —è–≤–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∫–ª–∞—Å—Å–µ); 
 * 		–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—É—á–∞—é—Ç –µ–≥–æ –ø–æ —Ü–µ–ø–æ—á–∫–µ –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å—Å—ã–ª–æ—á–Ω–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –Ω–∞ –≤—Ö–æ–¥–µ.
 * –°–∞–º–æ–π –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ calculate() –Ω–∞ –≤—Ö–æ–¥ –ø–æ–¥–∞—é—Ç—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ —è–≤–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ—Ç–æ–∫–∏ –≤–≤–æ–¥–∞/–≤—ã–≤–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –æ—Ç–∫—É–¥–∞ 
 * 		–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –∫—É–¥–∞ –≤—ã–≤–æ–¥–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –ü–æ—Ç–æ–∫ –≤—ã–≤–æ–¥–∞ –≤–æ –≤—Ä–µ–º—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –∏ –¥–ª—è –æ—à–∏–±–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ 
 * 		–≤ —Ñ-—Ü–∏–∏ calculate(), –ø–æ—Ç–æ–∫ –∂–µ –≤–≤–æ–¥–∞, –ø–æ–º–∏–º–æ –ø—Ä–æ—á–µ–≥–æ, –¥–æ —Ü–∏–∫–ª–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —è–≤–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –ø—Ä–∏ 
 * 		–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Token_stream –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º—Å—è —É–∂–µ –≤—Å–µ–º–∏ –¥—Ä—É–≥–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏.
 * –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–≤ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–µ–∫—Å–µ–º—ã "from x" (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –≤–≤–æ–¥–∞ –Ω–∞ 'x') –∏ "to y" (–ø–æ—Ç–æ–∫–∞ –≤—ã–≤–æ–¥–∞ –Ω–∞ 'y').
 * –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —Å –≤—ã–∑–æ–≤–æ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ calculate() —á–µ—Ä–µ–∑ –µ—ë –∂–µ —Ä–µ–∫—É—Ä—Å–∏—é.
 * –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–∫–æ–±–∫–∏ {} .
 * 
 * –î–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–æ–±–∏—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –¢–û–õ–¨–ö–û –¥–ª—è —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª —Å —É—á—ë—Ç–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–π:
 * & (–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ò n-—ã–π –±–∏—Ç —á–∏—Å–ª–∞ x&y == 1 –µ—Å–ª–∏ n-–π –æ–±–æ–∏—Ö –æ–ø–µ—Ä–∞–Ω–¥–æ–≤ —Ä–∞–≤–µ–Ω 1)
 * | (–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –ò–õ–ò n-—ã–π –±–∏—Ç —á–∏—Å–ª–∞ x|y == 1 –µ—Å–ª–∏ n-–π –ª—é–±–æ–≥–æ –∏–∑ –æ–ø–µ—Ä–∞–Ω–¥–æ–≤ (–ª–∏–±–æ –æ–±–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ) —Ä–∞–≤–µ–Ω 1)
 * ^ (–∏—Å–∫–ª—é—á–∞—é—â–µ–µ –ò–õ–ò n-—ã–π –±–∏—Ç —á–∏—Å–ª–∞ x^y == 1 –µ—Å–ª–∏ –ª–∏–±–æ n-–π –±–∏—Ç —á–∏—Å–ª–∞ x, –ª–∏–±–æ n-–π –±–∏—Ç —á–∏—Å–ª–∞ y —Ä–∞–≤–µ–Ω 1, –Ω–æ –Ω–µ –æ–±–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
 * ~ (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ; n-—ã–π –±–∏—Ç —á–∏—Å–ª–∞ ~x –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–µ–Ω n-–æ–º—É –±–∏—Ç—É —á–∏—Å–ª–∞ x)
 * 
 * –í–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –±–æ–ª—å—à–µ–≥–æ —É–ø—Ä–æ—â–µ–Ω–∏—è —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —á–∞—Å—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –≤ —Ç–æ–º —á–∏—Å–ª–µ —Å —Ü–µ–ª—å—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ–∑–≤–µ–¥–µ–Ω–∏—è –≤ —Å—Ç–µ–ø–µ–Ω—å,
 *  –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ —Ñ–æ—Ä–º–∞ –≤–æ–∑–≤–µ–¥–µ–Ω–∏—è –≤ —Å—Ç–µ–ø–µ–Ω—å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ '^' –Ω–∞ 'pow(–ß–ò–°–õ–û, –°–¢–ï–ü–ï–ù–¨)'
*/
#include "token.h"
#include <console_encoding.h>
#include <cmath>


//------------------------------------------------------------------------------

ConsoleCP cp {};	//–í–∫–ª—é—á–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π –µ—Å–ª–∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞

//------------------------------------------------------------------------------

const string quit_question = "–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É?";



class Change_Input {};
class Change_Output {};
//void calculate(istream& ist, ostream& ost);


//Token_stream ts {};		//–æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å —á–ª–µ–Ω–∞–º–∏ —Ñ-—Ü–∏–∏ ignore(), get() –∏ putback()
Symbol_table var_table;		//–æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏


double post_oper(double, Token_stream&);	//–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ pow_proc(), factorial(), primary()
double primary(Token_stream&);				//–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ pow_proc (–≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–µ–Ω—å)
double expression(Token_stream&);			//–æ–±—ä—è–≤–ª—è–µ–º, —Ç.–∫. —Ñ-—Ü–∏—è primary() –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å expression()
double loperator_or(Token_stream&);			//–æ–±—ä—è–≤–ª—è–µ–º, —Ç.–∫. —Ñ-—Ü–∏—è primary() –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å loperator_or()

//------------------------------------------------------------------------------

double pow_proc(Token_stream& ts)
//–≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–µ–Ω—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –ª–∏–±–æ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ  
{
	Token t = ts.get();
	if(t.kind != '(')		error("–ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ 'pow' –æ–∂–∏–¥–∞–ª–∞—Å—å –æ—Ç–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ - '(' ( pow_proc() )");
	
	double num_left = loperator_or(ts); //–ø–æ–ª—É—á–∞–µ–º –∫–æ–Ω–µ—á–Ω–æ–µ —á–∏—Å–ª–æ –≤ —Å–∫–æ–±–∫–∞—Ö
	
	t = ts.get();
	if(t.kind != ',')		error("–º–µ–∂–¥—É —á–∏—Å–ª–æ–º –∏ —Å—Ç–µ–ø–µ–Ω—å—é –æ–∂–∏–¥–∞–ª–∞—Å—å —Ä–∞–∑–¥–µ–ª—è—é—â–∞—è –∑–∞–ø—è—Ç–∞—è - ',' ( pow_proc() )");
	
	double pow_rght = loperator_or(ts); //–ø–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–µ–ø–µ–Ω–∏
	
	errno = 0;
	double res = pow(num_left,pow_rght); //–ø–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤–µ–¥–µ–Ω–∏—è —á–∏—Å–ª–∞ num_left –≤ —Å—Ç–µ–ø–µ–Ω—å pow_rght
	if(errno == ERANGE)
	{
		string err_str {"–ø—Ä–∏ –≤–æ–∑–≤–µ–¥–µ–Ω–∏–∏ —á–∏—Å–ª–∞ " + to_string(num_left) + " –≤ —Å—Ç–µ–ø–µ–Ω—å " + to_string(pow_rght)};
		err_str += " –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω DOUBLE ( pow_proc() )";
		error(err_str);
	}
	
	t = ts.get();
	if(t.kind != ')')		error ("–æ–∂–∏–¥–∞–ª–∞—Å—å –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ - ')' ( pow_proc() )");
	
	return res;
}

double factorial(double num, Token_stream& ts) //–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞. –ù–∞ –≤—Ö–æ–¥ —Ç–æ–ª—å–∫–æ —Ü–µ–ª—ã–µ –ø–æ–ª–æ–∂–∏—Ç. —á–∏—Å–ª–∞
{
	if (num - int(num) != 0)
		error ("—Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç –¶–ï–õ–û–ì–û —á–∏—Å–ª–∞ ( factorial() )");
	
	else if (num == 0) return 1;		//–§–∞–∫—Ç–æ—Ä–∏–∞–ª –Ω—É–ª—è —Ä–∞–≤–µ–Ω –µ–¥–∏–Ω–∏—Ü–µ
	
	else if (num < 0)
		error ("—Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–û–ì–û —á–∏—Å–ª–∞ ( factorial() )");
	
	
	double answer = 1;
	for (double i = 1; i <= num; ++i)
	{
		answer *= i;
		
		//–ï—Å–ª–∏ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞ –æ—Ç–≤–µ—Ç —Ä–∞–≤–µ–Ω inf –∏–ª–∏ -inf (+-–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
		if ( isinf(answer) )
			 error ("–ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞ —á–∏—Å–ª–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω DOUBLE ( factorial() )");
	}
	
	 //–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è, —Ç.–∫. –∑–∞ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–æ–º –º–æ–∂–µ—Ç —Å—Ç–æ—è—Ç—å –µ—â—ë –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –æ–ø–µ—Ä–∞—Ç–æ—Ä –∏–ª–∏ —Å–∏–º–≤–æ–ª
	return post_oper(answer, ts);
}

double post_oper(double left, Token_stream& ts)
//–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–¥—ë—Ç –ª–∏ –¥–∞–ª—å—à–µ –∫–∞–∫–æ–π-–ª–∏–±–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä, —Ç.–µ. –∑–∞–≤–µ—Ä—à–µ–Ω–æ –ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
//–ï—Å–ª–∏ –≤—Å—ë –≤–µ—Ä–Ω–æ, –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–µ–∫—Å–µ–º—É –∫–∞–∫ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –≤—ã–∑—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
//–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª –∏–ª–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–Ω—å
{
	Token t = ts.get();
	
	switch (t.kind)
	{
		case '!': //—Å–∏–º–≤–æ–ª '!' –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞
			return factorial(left, ts); //–ü—Ä–æ–±—É–µ–º –≤—ã—á–∏—Å–ª–∏—Ç—å —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª —á–∏—Å–ª–∞
		
		case PRINT:
		case ')':
		case ',':
		case '&': case '|': case '^':
		case '+': case '-': case '*': case '/': case '%':
			//cin.unget();
			ts.putback(t); //–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–º–≤–æ–ª –≤ –ø–æ—Ç–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤, –∏–Ω–∞—á–µ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è
			return left;
			
		default:
			error ("–æ–∂–∏–¥–∞–ª—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä (<–Ω–∞–∂–∞—Ç–∏–µ Enter>, +, -, *, /, %, !, &, |, ^) ( post_oper() )");
	}
}

//------------------------------------------------------------------------------

//–æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–∏—Å–µ–ª, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, —É–Ω–∞—Ä–Ω–æ–≥–æ –º–∏–Ω—É—Å–∞ –∏ –ø–ª—é—Å–∞, –¥–≤—É—Ö –≤–∏–¥–æ–≤ —Å–∫–æ–±–æ–∫, –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –∫–æ—Ä–Ω—è –∏ –≤–æ–∑–≤–µ–¥–µ–Ω–∏—è –≤ —Å—Ç–µ–ø–µ–Ω—å
// –∏ –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–±–∏—Ç–æ–≤–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ '~' (–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)
//–¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Å—Ç–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
double primary(Token_stream& ts)
{
	Token t = ts.get();
	
	switch (t.kind)
	{
		//—Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é '(' –≤—ã—Ä–∞–∂–µ–Ω–∏–µ ')'
		case '(':
		{
			double d = loperator_or(ts);
			t = ts.get();

			if (t.kind != ')')
				error ("–æ–∂–∏–¥–∞–ª–∞—Å—å –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ - ')' ( primary() )");
			
			return post_oper(d, ts);
		}
		
		case NUMBER:            //—Å–∏–º–≤–æ–ª '8' –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –æ–±—ä–µ–∫—Ç —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º
			return post_oper(t.value, ts); //–ø–æ–ª—É—á–∞–µ–º —Å–∞–º–æ —á–∏—Å–ª–æ
		
		//–£–Ω–∞—Ä–Ω—ã–π –º–∏–Ω—É—Å –∏ –ø–ª—é—Å
		case '-': //–ü–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ
			return post_oper(- primary(ts), ts);
		case '+':
			return post_oper(primary(ts), ts);
		
		//–≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–µ–Ω—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'pow(–ß–ò–°–õ–û, –°–¢–ï–ü–ï–ù–¨)'
		case POW:
			return post_oper( pow_proc(ts), ts );
		
		//–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –∫–æ—Ä–Ω—è
		case SQRT:
		{
			t = ts.get();
			if (t.kind != '(')
				error ("–ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ 'sqrt' –æ–∂–∏–¥–∞–ª–∞—Å—å –æ—Ç–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ - '(' ( primary() )");
			
			double d = expression(ts); //–ø–æ–ª—É—á–∞–µ–º –∫–æ–Ω–µ—á–Ω–æ–µ —á–∏—Å–ª–æ –≤ —Å–∫–æ–±–∫–∞—Ö
			if (d < 0)
				error ("–∫–æ—Ä–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–û–ì–û —á–∏—Å–ª–∞ ( primary() )");
			
			t = ts.get();
			if (t.kind != ')')
				error ("–æ–∂–∏–¥–∞–ª–∞—Å—å –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ - ')' ( primary() )");
			
			return post_oper( sqrt(d), ts );
		}
		
		//—Å–∏–º–≤–æ–ª 'a' –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
		//–∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ –µ—ë –∏–º–µ–Ω–∏
		case VARIABLE:
		{
			string strname = t.name;
			
			t = ts.get();
			if (t.kind == '=') {//–ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
				double d = expression(ts); //–ø–æ–ª—É—á–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
				
				//–ø—ã—Ç–∞–µ–º—Å—è –∏–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ (–æ—à–∏–±–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç —Ç–∞–∫–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏–ª–∏ –µ—Å–ª–∏ —ç—Ç–æ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞)
				var_table.set(strname, d);
				return d;
			}
			
			else { //–ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ —Å—Ç—Ä–æ–∫–µ —Å –µ—ë –∏–º–µ–Ω–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è—Ö
				ts.putback(t);
				return post_oper( var_table.get(strname), ts );
			}
		}
		
		//–õ–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–æ–±–∏—Ç–æ–≤—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä "–î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ" –¥–ª—è —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª
		case '~':
		{
			double d = primary(ts);
			if( d != int(d) )		error("–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–±–∏—Ç–æ–≤—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä –î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ('~') —Ç—Ä–µ–±—É–µ—Ç —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞ ( primary() )");
			return post_oper( ~int(d), ts );
		}
		
		default:
			error ("–æ–∂–∏–¥–∞–ª–æ—Å—å –ø–µ—Ä–≤–∏—á–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ ( primary() )");
	}
}

//------------------------------------------------------------------------------

//–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ *, / –∏ %
double term(Token_stream& ts)
{
	double left = primary(ts); //—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –≤—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–≤–∏—á–Ω–æ–µ_–≤—ã—Ä–∞–∂–µ–Ω–∏–µ

	while (true) {
		Token t = ts.get();  //–ø–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥. –æ–±—ä–µ–∫—Ç token –∏–∑ –ø–æ—Ç–æ–∫–∞ token'–æ–≤
		switch (t.kind)
		{
			case '*':
				left *= primary(ts); //–≤—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–≤–∏—á–Ω–æ–µ_–≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏ —É–º–Ω–æ–∂–∞–µ–º
				break;
			
			case '/':
			{
				double d = primary(ts);
				if (d == 0)		error ("–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω—É–ª—å ( term() )");
				
				left /= d; //–≤—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–≤–∏—á–Ω–æ–µ_–≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏ –¥–µ–ª–∏–º
				break;
			}
			
			case '%':
			{
				double d = primary(ts);
				if (d == 0)		error ("–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω—É–ª—å ( term() )");
				
				left = fmod(left,d);
				/* –§-—Ü–∏—è –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è –æ—Å—Ç–∞—Ç–æ–∫ –æ—Ç –¥–µ–ª–µ–Ω–∏—è
				–¥–∞–∂–µ –ø—Ä–∏ –¥–µ–ª–µ–Ω–∏–∏ —á–∏—Å–µ–ª –≤ –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç—å—é, –Ω–∞–ø—Ä–∏–º–µ—Ä:
					6.7 % 3.3 = 6.7 - 3.3 * int(6.7/3.3) = 0.1
				*/
				break;
			}
			
			default:
				ts.putback(t);		//–≤–æ–∑–≤—Ä–∞—â–∞–µ–º t –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–æ—Ç–æ–∫ token'–æ–≤
				return left;
		}
	}
}

//------------------------------------------------------------------------------

//–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ + –∏ -
double expression(Token_stream& ts)
{
	double left = term(ts);			//—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –≤—ã—á–∏—Å–ª—è–µ–º Term
	
	while (true) {
		errno = 0;
		Token t = ts.get();			//–ø–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥. –æ–±—ä–µ–∫—Ç Token –∏–∑ –ø–æ—Ç–æ–∫–∞ Token'–æ–≤
		switch (t.kind)
		{
			case '+':
				left += term(ts);	//–≤—ã—á–∏—Å–ª—è–µ–º Term –∏ –ø—Ä–∏–±–∞–≤–ª—è–µ–º
				if(errno == ERANGE)		error("—á–∏—Å–ª–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω DOUBLE ( expression() )");
				break;
			
			case '-':
				left -= term(ts);	//–≤—ã—á–∏—Å–ª—è–µ–º Term –∏ –æ—Ç–Ω–∏–º–∞–µ–º
				if(errno == ERANGE)		error("—á–∏—Å–ª–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω DOUBLE ( expression() )");
				break;
			
			default:
				ts.putback(t);		//–≤–æ–∑–≤—Ä–∞—â–∞–µ–º t –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–æ—Ç–æ–∫ token'–æ–≤
				if(errno == ERANGE)		error("—á–∏—Å–ª–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω DOUBLE ( expression() )");
				return left;		//–Ω–∞–∫–æ–Ω–µ—Ü: –±–æ–ª—å—à–µ –Ω–µ—Ç + –∏–ª–∏ -: –¥–∞–ª–µ–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –±–æ–ª–µ–µ –Ω–∏–∑–∫–∏–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–æ–±–∏—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
		}
	}
}

//–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ &
double loperator_and(Token_stream& ts)
{
	double left = expression(ts);	//—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –≤—ã—á–∏—Å–ª—è–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
	
	while (true) {
		Token t = ts.get();				//–ø–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥. –æ–±—ä–µ–∫—Ç Token –∏–∑ –ø–æ—Ç–æ–∫–∞ Token'–æ–≤
		switch (t.kind)
		{
			case '&':
			{
				double d = expression(ts);
				if( left != int(left)  ||  d != int(d) )
					error("–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–±–∏—Ç–æ–≤—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä –ò ('&') —Ç—Ä–µ–±—É–µ—Ç —Ü–µ–ª—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ ( term() ). –¢–∞–∫–∂–µ –≤–æ–∑–º–æ–∂–Ω–æ —á—Ç–æ —á–∏—Å–ª–æ (–∏–ª–∏ –æ–±–∞) —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ");
				left = int(left) & int(d);
				break;
			}
			
			default:
				ts.putback(t);			//–≤–æ–∑–≤—Ä–∞—â–∞–µ–º t –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–æ—Ç–æ–∫ token'–æ–≤
				return left;
		}
	}
}

//–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ ^
double loperator_xor(Token_stream& ts)
{
	double left = loperator_and(ts);	//—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –≤—ã—á–∏—Å–ª—è–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
	
	while (true) {
		Token t = ts.get();				//–ø–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥. –æ–±—ä–µ–∫—Ç Token –∏–∑ –ø–æ—Ç–æ–∫–∞ Token'–æ–≤
		switch (t.kind)
		{
			case '^':
			{
				double d = loperator_and(ts);
				if( left != int(left)  ||  d != int(d) )
					error("–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–±–∏—Ç–æ–≤—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä –ò—Å–∫–ª—é—á–∞—é—â–µ–µ –ò–õ–ò ('^') —Ç—Ä–µ–±—É–µ—Ç —Ü–µ–ª—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ ( term() ). –¢–∞–∫–∂–µ –≤–æ–∑–º–æ–∂–Ω–æ —á—Ç–æ —á–∏—Å–ª–æ (–∏–ª–∏ –æ–±–∞) —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ");
				left = int(left) ^ int(d);
				break;
			}
			
			default:
				ts.putback(t);			//–≤–æ–∑–≤—Ä–∞—â–∞–µ–º t –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–æ—Ç–æ–∫ token'–æ–≤
				return left;
		}
	}
}

//–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ |
double loperator_or(Token_stream& ts)
{
	//errno = 0;
	double left = loperator_xor(ts);	//—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –≤—ã—á–∏—Å–ª—è–µ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
	//if(errno == ERANGE)		error("—á–∏—Å–ª–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω DOUBLE ( loperator_or() )");
	
	while (true) {
		//errno = 0;
		Token t = ts.get();				//–ø–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥. –æ–±—ä–µ–∫—Ç Token –∏–∑ –ø–æ—Ç–æ–∫–∞ Token'–æ–≤
		switch (t.kind)
		{
			case '|':
			{
				double d = loperator_xor(ts);
				if( left != int(left)  ||  d != int(d) )
					error("–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–±–∏—Ç–æ–≤—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä –ò–õ–ò ('|') —Ç—Ä–µ–±—É–µ—Ç —Ü–µ–ª—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ ( term() ). –¢–∞–∫–∂–µ –≤–æ–∑–º–æ–∂–Ω–æ —á—Ç–æ —á–∏—Å–ª–æ (–∏–ª–∏ –æ–±–∞) —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ");
				left = int(left) | int(d);
				break;
			}
			
			default:
				ts.putback(t);			//–≤–æ–∑–≤—Ä–∞—â–∞–µ–º t –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–æ—Ç–æ–∫ token'–æ–≤
				//if(errno == ERANGE)		error("—á–∏—Å–ª–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω DOUBLE ( expression() )");
				return left;			//–±–æ–ª—å—à–µ –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤, –≤ —Ç–æ–º —á–∏—Å–ª–µ —Å–∞–º–æ–≥–æ –Ω–∏–∑–∫–æ–≥–æ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–±–∏—Ç–æ–≤–æ–≥–æ –?–õ–?: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç
		}
	}
}

//------------------------------------------------------------------------------

double declaration(bool cnst, Token_stream& ts)
//–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞ –ø—Ä–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π;
//–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π —Ä–∞–Ω–µ–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤ –º–∞—Å—Å–∏–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
//–ù–∞ –≤—Ö–æ–¥ - —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ–π (true –µ—Å–ª–∏ –¥–∞)
{
	Token t = ts.get();
	
	if (t.kind == HELP || t.kind == QUIT || t.kind == POW || t.kind == SQRT ||
		  t.kind == TABLEOUT || t.kind == CHANGEINPUT || t.kind == CHANGEOUTPUT)
		error ("–∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π/–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –Ω–µ –º–æ–∂–µ—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –∫–æ–º–∞–Ω–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã  ( declaration() )");
	
	else if (t.kind == NUMBER)
		error ("–≤–≤–µ–¥—ë–Ω–Ω–æ–µ –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π/–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º  ( declaration() )");
	
	else if (var_table.is_declared(t.name))
		error ("–ø–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π/–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ( declaration() )");
	
	
	string name = t.name;
	
	t = ts.get();
	if (t.kind != '=')
		error ("–ø—Ä–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø—Ä–æ–ø—É—â–µ–Ω —Å–∏–º–≤–æ–ª '=' ( declaration() )");
	
	double d = expression(ts);
	var_table.define(name, d, cnst);
	
	return d;
}

//–û–ø—Ä–µ–¥–µ–ª—è–µ–º —á—Ç–æ –ø–æ–¥–∞–ª –Ω–∞ –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - 
//–æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
double statement(Token_stream& ts)
{
	Token t = ts.get();
	switch (t.kind) {
		case LET: //–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ–±—ä—è–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
			return declaration(false, ts);
		
		 case CONSTANT: //–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ–±—ä—è–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É
			return declaration(true, ts);
		
		default: //–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –¥—Ä—É–≥—É—é –æ–ø–µ—Ä–∞—Ü–∏—é (–≤—ã—á–∏—Å–ª–µ–Ω–∏—è)
			ts.putback(t); //–≤–æ–∑–≤—Ä–∞—â–∞–µ–º t –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–æ—Ç–æ–∫ token'–æ–≤
			return loperator_or(ts);
	}
}

void calculate(istream& ist, ostream& ost) //–¶–∏–∫–ª –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è
{
	Token_stream ts {ist};
	
	while (ist)
	try 
	{
		if( &ist == &cin )		cout << PROMPT; //–ß—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∫–æ –≤–≤–æ–¥—É
		
		Token t = ts.get();
		while(t.kind == PRINT)		t = ts.get();
		
		//–ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ 'quit' - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã
		if(t.kind == QUIT)					return;
		
		//–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ-—Ü–∏–∏ calculate() –≤—ã–≤–æ–¥—è—â–µ–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏ –≤–Ω–æ–≤—å –∑–∞–ø—É—Å–∫–∞—é—â–µ–µ —Ä–∞—Å—á—ë—Ç—ã
		else if (t.kind == HELP)			error (HELPKEY);
		
		//–≤—ã–≤–æ–¥ –≤—Å–µ—Ö —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç
		else if (t.kind == TABLEOUT)		error (TABLEOUTKEY);
		
		//–°–º–µ–Ω–∞ –ø–æ—Ç–æ–∫–æ–≤ –≤–≤–æ–¥–∞/–≤—ã–≤–æ–¥–∞
		else if (t.kind == CHANGEINPUT)		throw Change_Input{};
		else if (t.kind == CHANGEOUTPUT)	throw Change_Output{};
		
		
		ts.putback(t);
		
		double res = 0;
		res = statement(ts);
		
		ost << RESULT << res << "\n\n";
		if ( &ost != &cout ) //–ß—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Ç–æ –∂–µ —á—Ç–æ –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª
			cout << RESULT << res << "\n\n";
	}
	
	catch (exception& e) { //–î–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø—Ä–æ–≥—Ä–∞–º–º–æ–π
		string str = e.what();
		
		if ( str == HELPKEY  &&  &ost == &cout )
			ost << HELP_INSTR;	//–í–´–í–û–î –ò–ù–°–¢–†–£–ö–¶–ò–ò —Ç–æ–ª—å–∫–æ –≤ –ø–æ—Ç–æ–∫ cout
		
		else if ( str == TABLEOUTKEY  &&  &ost == &cout )
			var_table.table_out();	//–í—ã–≤–æ–¥ –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö/–∫–æ–Ω—Å—Ç–∞–Ω—Ç  —Ç–æ–ª—å–∫–æ –≤ –ø–æ—Ç–æ–∫ cout
		
		else {
			if ( &ost != &cout )
				cout << "–û—à–∏–±–∫–∞ ( calculate() ): " << str << "\n\n";
			ost << "–û—à–∏–±–∫–∞ ( calculate() ): " << str << "\n\n";
		}
		
		//if ( &ist == &cin )
		//getline(ist, str);
		//ist.clear();
		ts.ignore(PRINT);
	}
	
	catch (Change_Input) { //–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –≤–≤–æ–¥–∞. –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ main()
		string input_TS  = "cin";
		string output_TS = "cout";
		
		for (char ch = '0'; cin >> ch  &&  isspace(ch); ) {} 
		cin.unget();
		
		getline(cin, input_TS);
		cin.putback('\n');
		
		if ( Y_or_N("–í—ã–≤–æ–¥ —Å—Ç–æ–∏—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –≤ —Ñ–∞–π–ª?") ) {
			cout << "–í–≤–µ–¥–∏—Ç–µ –ø–æ—Ç–æ–∫/—Ñ–∞–π–ª –¥–ª—è –≤—ã–≤–æ–¥–∞: ";
			
			for (char ch = '0'; cin >> ch  &&  isspace(ch); ) {}
			cin.unget();
			
			getline(cin, output_TS);
		}
		
		
		if ( input_TS  == "cin" )
			if ( output_TS  == "cout" )		calculate(cin, cout);
			else {
				ofstream file_ost { output_TS };
				if (!file_ost)	error("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª '" + output_TS + "'");
				
				calculate(cin, file_ost);
			}
			
		else {
			ifstream file_ist { input_TS };
			if (!file_ist)	error("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª '" + input_TS + "'");
			file_ist.exceptions(file_ist.exceptions()|ios_base::badbit);
			
			if ( output_TS  == "cout" )		calculate(file_ist, cout);
			else {
				ofstream file_ost { output_TS };
				if (!file_ost)	error("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª '" + output_TS + "'");
				
				calculate(file_ist, file_ost);
			}
		}
		
		
		ost << "\n\n\t–ü–û–¢–û–ö –ó–ê–ö–†–´–¢\n\n";
		if ( &ost != &cout )  //–ß—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Ç–æ –∂–µ —á—Ç–æ –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª
			cout << "\n\n\t–ü–û–¢–û–ö –ó–ê–ö–†–´–¢\n\n";
		
		//getline(ist, output_TS);
		ist.clear();
	}
	
	catch (Change_Output) { //–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –≤—ã–≤–æ–¥–∞. –ú–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ main()
		string output_TS = "cout";
		
		for (char ch = '0'; cin >> ch  &&  isspace(ch); ) {}
		cin.unget();
		
		getline(cin, output_TS);
		cin.putback('\n');
		
		if ( output_TS  == "cout" )		calculate(cin, cout);
		else {
			ofstream file_ost { output_TS };
			if (!file_ost)	error("–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª '" + output_TS + "'");
			
			calculate(cin, file_ost);
		}
		
		
		ost << "\n\n\t–ü–û–¢–û–ö –ó–ê–ö–†–´–¢\n\n";
		if ( &ost != &cout )  //–ß—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ —Ç–æ –∂–µ —á—Ç–æ –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª
			cout << "\n\n\t–ü–û–¢–û–ö –ó–ê–ö–†–´–¢\n\n";
		
		//getline(ist, output_TS);
		ist.clear();
	}
}

//------------------------------------------------------------------------------

int main()
{
	cout << "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä 2022 –ø–æ –ë—å—è—Ä–Ω–µ –°—Ç—Ä–∞—É—Å—Ç—Ä—É–ø—É.\n\n"
			"–ü–æ—Å–ª–µ –∑–Ω–∞–∫–∞ '>' –≤–≤–æ–¥–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ß–ò–°–õ–û –û–ü–ï–†–ê–¢–û–† –ß–ò–°–õ–û. "
			"–ß–∏—Å–ª–∞ –º–æ–≥—É—Ç –±—ã—Ç—å —Å –ª—é–±—ã–º –∑–Ω–∞–∫–æ–º, —Ü–µ–ª—ã–º–∏ –∏ —Å –¥–µ—Å—è—Ç–∏—á–Ω–æ–π —á–∞—Å—Ç—å—é ("
			"–¢–û–ß–ö–ê - –¥–µ—Å—è—Ç–∏—á–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å).\n"
			"–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–≤–æ–¥–∞ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è) –Ω–∞–∂–º–∏—Ç–µ –∫–ª–∞–≤–∏—à—É ENTER.\n\n"
			"   out - –≤—ã–≤–æ–¥ –≤—Å–µ—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n"
			"   help - –≤—ã–∑–æ–≤ —Å–ø—Ä–∞–≤–∫–∏\n   quit - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã—Ö–æ–¥–∞\n\n"; //–ü–†–ò–í–ï–¢–°–¢–í–ò–ï
	
	var_table.define("pi", 3.1415926535, true);
	var_table.define("e", 2.7182818284, true);
	var_table.define("k", 1000, true);
	
	
	while (true)
	{
		try
		{
			calculate(cin, cout);
			
			//keep_window_open("~~");
			/*if ( Y_or_N(quit_question) )*/	return 0;
		}

		catch (exception& e) { //–î–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø—Ä–æ–≥—Ä–∞–º–º–æ–π
			cerr << "–û—à–∏–±–∫–∞ ( main() ): " << e.what() << '\n';
			
			if ( Y_or_N(quit_question) )	return 1001;
		}
		
		catch (...) { //–î–ª—è –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
			cerr << "–£–ø—Å! –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ! ( main() )\n";
			
			if ( Y_or_N(quit_question) )	return 1001;
		}
	}
}