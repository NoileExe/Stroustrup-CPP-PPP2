// calculator01.cpp
//–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–≤–æ–¥–∞ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç

#include <yes_or_no.h>
#include <console_encoding.h>
#include <std_lib_facilities.h>

//------------------------------------------------------------------------------

ConsoleCP cp {};	//–í–∫–ª—é—á–∞–µ—Ç —Ä—É—Å—Å–∫–∏–π –µ—Å–ª–∏ –Ω–µ –≤–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞

//------------------------------------------------------------------------------

double post_oper(double); //–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ pow_proc, factorial, primary
double primary(); //–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ pow_proc (–≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–µ–Ω—å)
double expression(); //–æ–±—ä—è–≤–ª—è–µ–º, —Ç.–∫. —Ñ-—Ü–∏—è primary() –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å expression()


const char NUMBER = '8'; //t.kind == NUMBER –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ t - —á–∏—Å–ª–æ
const char PRINT = '\n'; //t.kind == PRINT –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ t - –ª–µ–∫—Å–µ–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ä–µ—à–µ–Ω–∏—è
const char POW = '^'; //t.kind == POW –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ t - –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–æ–∑–≤–µ–¥–µ–Ω–∏—è –≤ —Å—Ç–µ–ø–µ–Ω—å

const char CONSTANT = '$'; //—Ç–æ–∫–µ–Ω —Å –¥–∞–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
const char LET = '#'; //—Ç–æ–∫–µ–Ω —Å –¥–∞–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
const char VARIABLE = 'a'; //—Ç–æ–∫–µ–Ω –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞–¥ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π

const string PROMPT = "> "; //–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∫–æ –≤–≤–æ–¥—É
const string RESULT = "= "; //–¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –Ω–∞ —Ç–æ —á—Ç–æ –∑–∞ –¥–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º —Å–ª–µ–¥—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏–π

const string SQRTKEY = "sqrt";
const char SQRT = 'S';
//t.kind == SQRT –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ t - –æ–ø–µ—Ä–∞—Ç–æ—Ä –∏–∑–≤–ª–µ—á. –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –∫–æ—Ä–Ω—è

class CTRL_Z_throw { }; //–î–ª—è –≤—ã–∑–æ–≤–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –≤–≤–æ–¥–µ CTRL+Z, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –≤—ã–≤–æ–¥—É –Ω–∞ —ç–∫—Ä–∞–Ω –≤–æ–ø—Ä–æ—Å–∞ –æ –≤—ã—Ö–æ–¥–µ
const string TABLEOUTKEY = "out";
const char TABLEOUT = 'T';
//t.kind == TABLEOUT –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ t - –ª–µ–∫—Å–µ–º–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç

const string QUITKEY = "quit";
const char QUIT = 'Q';
//t.kind == QUIT –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ t - –ª–µ–∫—Å–µ–º–∞ –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã

const string HELPKEY = "help";
const char HELP = 'H'; //—Ç–æ–∫–µ–Ω —Å –¥–∞–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –≤—ã–∑–æ–≤–∞
const string HELP_INSTR = "\n\n–í–≤–æ–¥–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ß–ò–°–õ–û –û–ü–ï–†–ê–¢–û–† –ß–ò–°–õ–û."
			"\n–ß–∏—Å–ª–∞ –º–æ–≥—É—Ç –±—ã—Ç—å —Å –ª—é–±—ã–º –∑–Ω–∞–∫–æ–º, —Ü–µ–ª—ã–º–∏ –∏ —Å –¥–µ—Å—è—Ç–∏—á–Ω–æ–π —á–∞—Å—Ç—å—é "
			"(–¢–û–ß–ö–ê - –¥–µ—Å—è—Ç–∏—á–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å). "
			"–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–≤–æ–¥–∞ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è) –Ω–∞–∂–º–∏—Ç–µ –∫–ª–∞–≤–∏—à—É ENTER.\n\n"
			
			"–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:\n\n"
			"-----------------------------------------------------\n"
			"|    +    |    -    |     *     |    /    |    %    |\n"
			"|---------+---------+-----------+---------+---------|\n"
			"|         |         |           |         | –æ—Å—Ç–∞—Ç–æ–∫ |\n"
			"| —Å–ª–æ–∂–∏—Ç—å | –æ—Ç–Ω—è—Ç—å  |  —É–º–Ω–æ–∂–∏—Ç—å |  –¥–µ–ª–∏—Ç—å |   –æ—Ç    |\n"
			"|         |         |           |         | –¥–µ–ª–µ–Ω–∏—è |\n"
			"-----------------------------------------------------\n"
			
			"------------------------------------------------------------\n"
			"|   ()   |   {()}    |    ^     |   –ß–ò–°–õ–û!  |  sqrt(–ß–ò–°–õ–û) |\n"
			"|--------+-----------+----------+-----------+--------------|\n"
			"|        | –≤–ª–æ–∂–µ–Ω–Ω—ã–µ | –≤–æ–∑–≤–µ—Å—Ç–∏ |           |  –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π  |\n"
			"| —Å–∫–æ–±–∫–∏ |   —Å–∫–æ–±–∫–∏  |    –≤     | —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª |    –∫–æ—Ä–µ–Ω—å    |\n"
			"|        |           | —Å—Ç–µ–ø–µ–Ω—å  |           |   –∏–∑ —á–∏—Å–ª–∞   |\n"
			"------------------------------------------------------------\n"
			
			"\n–ü—Ä–∏–º–µ—Ä:\n> -2+(2*2) \n= 2\n\n"
			
			"–í –ø—Ä–æ–≥—Ä–∞–º–º–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã (—á–∏—Å–ª–æ –ü–∏, —á–∏—Å–ª–æ e –∏ "
			"–º–Ω–æ–∂–∏—Ç–µ–ª—å —Ç—ã—Å—è—á–∞):\n pi = 3.1415926535\n e = 2.7182818284\n k = 1000\n\n"
			
			"–ò–º–µ–µ—Ç—Å—è —Ç–∞–∫–∂–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–±—ä—è–≤–ª—è—Ç—å –∏ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–≤–æ–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (#) "
			"–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ($), –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞—é—Ç—Å—è –µ–¥–∏–Ω–æ–∂–¥—ã –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è. "
			"–ò–º—è –¥–æ–ª–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –±—É–∫–≤—ã, –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª '_'."
			"\n–ü—Ä–∏–º–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π:\n> #var1=100 \n= 100\n"
			"\n–ü—Ä–∏–º–µ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π:\n> #var1 =5+.79 \n= 5.79\n"
			"\n–ü—Ä–∏–º–µ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã:\n> $ con_1 = 10 \n= 10\n"
			"\n–ü—Ä–∏–º–µ—Ä –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è:\n> var1-2 \n= 3.79\n\n"
			"   out - –≤—ã–≤–æ–¥ –≤—Å–µ—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n"
			"   help - –≤—ã–∑–æ–≤ —Å–ø—Ä–∞–≤–∫–∏\n   quit - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã—Ö–æ–¥–∞\n\n"; //–ò–ù–°–¢–†–£–ö–¶–ò–ò

//------------------------------------------------------------------------------

class Token {
public:
	char kind;		//—á—Ç–æ –∑–∞ —Å–∏–º–≤–æ–ª
	double value;	 //–¥–ª—è —á–∏—Å–µ–ª: –∑–Ω–∞—á–µ–Ω–∏–µ
	string name;	  //–¥–ª—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö: –∏–º—è
	
	Token(char ch)				 //–æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ Token –∏–∑ —Å–∏–º–≤–æ–ª–∞
		:kind(ch), value(0) { }
	Token(char ch, double val)	 //–æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ Token –∏–∑ —Å–∏–º–≤–æ–ª–∞ –∏ —á–∏—Å–ª–∞ double
		:kind(ch), value(val) { }
	Token(char ch, string n)
		:kind{ch}, name{n} { }	 //–∏–º–µ–Ω–æ–≤–∞–Ω–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
};

//------------------------------------------------------------------------------

class Token_stream {
public:
	Token_stream() :full(0), buffer(0) { }   //—Å–æ–∑–¥–∞—ë–º Token_stream –∫–æ—Ç–æ—Ä—ã–π —á–∏—Ç–∞–µ—Ç –∏–∑ –ø–æ—Ç–æ–∫–∞ –≤–≤–æ–¥–∞ cin
	
	Token get();	  //–ø–æ–ª—É—á–∞–µ–º –æ–±—ä–µ–∫—Ç Token (—á–ª–µ–Ω get() –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ)
	void putback(Token t); //–≤–æ–∑–≤—Ä–∞—Ç Token –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ñ-—Ü–∏—é (–≤ –±—É—Ñ–µ—Ä)
	void ignore(char c); //–æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–∏–º–≤–æ–ª—ã –¥–æ —Å–∏–º–≤–æ–ª–∞ 'c' –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ
private:
	bool full;
	Token buffer;	 //–∑–¥–µ—Å—å —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç –∫–ª–∞—Å—Å–∞ Token, –ø–æ–º–µ—â—ë–Ω–Ω—ã–π –æ–±—Ä–∞—Ç–Ω–æ,
														// –∏—Å–ø–æ–ª—å–∑—É—è putback ()
};

//------------------------------------------------------------------------------

void Token_stream::ignore(char c)
//–°–∏–º–≤–æ–ª 'c' –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–∞–∑–Ω–æ–≤–∏–¥–Ω–æ—Å—Ç—å –ª–µ–∫—Å–µ–º
//–æ—Ç–±—Ä–æ—Å—ã–≤–∞–µ—Ç –≤—Å–µ —Å–∏–º–≤–æ–ª—ã –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –Ω–∞ –≤—Ö–æ–¥–µ –≤ —Ñ—É–Ω–∫—Ü–∏—é, –Ω–∏—á–µ–≥–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç
{
	//–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –±—É—Ñ–µ—Ä
	if (Token_stream::full && c == Token_stream::buffer.kind)
	{
		Token_stream::full = false;
		return;
	}
	
	//–ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
	Token_stream::full = false;
	char ch = 0;
	while (cin >> ch)
		if (ch == c || ch == '\n') return;  // || ch == '\n'
}

//–ß–ª–µ–Ω putback() –ø–æ–º–µ—â–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç –≤ –±—É—Ñ–µ—Ä —Å–≤–æ–µ–π —Ñ-—Ü–∏–∏ Token_stream:
void Token_stream::putback(Token t)
{
	if (Token_stream::full)
		error("–û—à–∏–±–∫–∞ —Ñ-—Ü–∏–∏ putback(): –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —É–∂–µ –ø–æ–ª–Ω—ã–π –±—É—Ñ–µ—Ä");

	Token_stream::buffer = t;	//–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å t –≤ –±—É—Ñ–µ—Ä
	Token_stream::full = true;	//—Ç–µ–ø–µ—Ä—å –±—É—Ñ–µ—Ä –ø–æ–ª–æ–Ω
}

Token Token_stream::get()
{
	 if (Token_stream::full) { //–ï—Å–ª–∏ –≤ –±—É—Ñ–µ—Ä–µ —É–∂–µ –∏–º–µ–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç —Ç–∏–ø–∞ Token..
		//..—É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ –±—É—Ñ–µ—Ä–∞ (–ø–æ–º–µ—á–∞–µ–º –±—É—Ñ–µ—Ä –∫–∞–∫ –ø—É—Å—Ç–æ–π, —Ç.–µ. –¥–æ—Å—Ç—É–ø–Ω—ã–π –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏)
		Token_stream::full = false;
		return Token_stream::buffer;
	}

	char ch = ' ';
	cin.get(ch); //–°—ä–µ–¥–∞–µ–º –ø—Ä–æ–±–µ–ª—ã while ( isspace(ch) && ch != PRINT && !cin.eof() ) 
	
	if (cin.eof())   throw CTRL_Z_throw {}; //–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É? –î–∞ –∏–ª–∏ –ù–µ—Ç (–¥ / –Ω)
	
	else if (ch == PRINT) return Token(PRINT); //–¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —ç–∫—Ä–∞–Ω
	cin.unget();
	
	cin >> ch;	//–∑–∞–º–µ—á–∞–Ω–∏–µ: –æ–ø–µ—Ä–∞—Ç–æ—Ä >> –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø—É—Å—Ç—ã–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
				  //(–ø—Ä–æ–±–µ–ª, —Å–∏–º–≤–æ–ª –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏, —Ç–∞–±—É–ª—è—Ü–∏—è –∏ —Ç.–¥.)
	switch (ch)
	{
		case LET: case CONSTANT: case '=': //–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
		case POW: //—Å—Ç–µ–ø–µ–Ω—å
		case '!': //—Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª
		case '(': case ')':
		case '{': case '}':
		case '+': case '-': case '*': case '/': case '%':
			return Token(ch);		//–ö–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∞–º —Å–µ–±—è
		
		case '.': //–ß–∏—Å–ª–æ —Å –ø–ª–∞–≤–∞—é—â–µ–π –∑–ø—Ç –º–æ–∂–µ—Ç –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å —Ç–æ—á–∫–∏
		case '0': case '1': case '2': case '3': case '4':
		case '5': case '6': case '7': case '8': case '9':
			cin.unget(); //–≤–æ–∑–≤—Ä–∞—Ç –∫–∞—Ä–µ—Ç–∫–∏ –Ω–∞ 1 —Å–∏–º–≤–æ–ª –Ω–∞–∑–∞–¥
			double val;
			cin >> val;		//—Å—á–∏—Ç—ã–≤–∞–µ–º —á–∏—Å–ª–æ —Å –ø–ª–∞–≤–∞—é—â–µ–π –ó–ü–¢
			
			//if ( ch == '.' && val == 0 )	error ("–Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –≤–≤–æ–¥ ( Token_stream::get() )");
			
			return Token(NUMBER, val);	//–ø–æ–º–µ—á–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–∏–º–≤–æ–ª–æ–º '8' –æ–∑–Ω–∞—á–∞—é—â–∏–º "—á–∏—Å–ª–æ"
		
		default:
		{
			string str = "";
			
			if ( isalpha(ch) ){ //–ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª - –±—É–∫–≤–∞ (–∏–º—è –º–æ–∂–µ—Ç –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ —Å –±—É–∫–≤—ã)
				str += ch;
				
				while (cin.get(ch) && (isalpha(ch) || isdigit(ch) || ch == '_'))
									   //–±—É–∫–≤–∞,		  —Ü–∏—Ñ—Ä–∞	–∏–ª–∏ –Ω–∏–∂–Ω–µ–µ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
					str += ch;
				
				cin.unget(); //–≤–æ–∑–≤—Ä–∞—Ç –∫–∞—Ä–µ—Ç–∫–∏ –Ω–∞ 1 —Å–∏–º–≤–æ–ª –Ω–∞–∑–∞–¥, —Ç.–∫. –æ–Ω –Ω–µ –∏–º–µ–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∫ –∏–º–µ–Ω–∏
				
				if (str == HELPKEY)				return Token(HELP);
				else if (str == QUITKEY)		return Token(QUIT);
				else if (str == SQRTKEY)		return Token(SQRT);
				else if (str == TABLEOUTKEY)	return Token(TABLEOUT);
				
				return Token(VARIABLE, str);
			}
			
			cin.clear();
			error ("–Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –≤–≤–æ–¥ ( Token_stream::get() )");
		}
	}
}

//------------------------------------------------------------------------------

struct Variable { //–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç
	string name;
	double value;
	bool constant;
	
	Variable(string n, double v)
		:name(n), value(v), constant(false)	{ }
	Variable(string n, double v, bool c)
		:name{n}, value{v}, constant{c}		{ }
};


class Symbol_table {
public:
	Symbol_table() { }   //—Å–æ–∑–¥–∞—ë–º Symbol_table, –∫–æ—Ç–æ—Ä—ã–π —á–∏—Ç–∞–µ—Ç –∏–∑ –ø–æ—Ç–æ–∫–∞ –≤–≤–æ–¥–∞ cin –ª–µ–∫—Å–µ–º—ã
	
	void table_out();				//–í—ã–≤–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω –≤—Å–µ—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
	double get(string s);			//–ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
	void set(string s, double d);	//–∏–∑–º–µ–Ω–∏—Ç—å (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å) –∑–Ω–∞—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
	bool is_declared(string s);		//–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
	void define(string name, double d, bool cnst);	//–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π —Ä–∞–Ω–µ–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π/–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ –º–∞—Å—Å–∏–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
private:
	vector<Variable> vector_names;
	//–≤–µ–∫—Ç–æ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç, –∞ —Ç–∞–∫ –∂–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –Ω–∏–º
};

void Symbol_table::table_out() //–í—ã–≤–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω –≤—Å–µ—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–¥—Ä—è–¥
{
	for (int i = 0; i < vector_names.size(); ++i) {
		cout << '\t' << i+1 << ". "; 
		
		if (vector_names[i].constant)		cout << "const " << CONSTANT;
		else							cout << "var   " << LET;
		
		cout << ' ' << vector_names[i].name << " = " << vector_names[i].value << ";\n";
	}
}

double Symbol_table::get(string s)
//–ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
//–Ω–∞ –≤—Ö–æ–¥: –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
//–Ω–∞ –≤—ã—Ö–æ–¥–µ: –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º (–µ—Å–ª–∏ —Ç–∞–∫–æ–≤–∞—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
{
	for (int i = 0; i < vector_names.size(); ++i)
		if (vector_names[i].name == s) return vector_names[i].value;
	
	error ("–ø–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ–æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π ( Symbol_table::get() )");
}

void Symbol_table::set(string s, double d)
//–∏–∑–º–µ–Ω–∏—Ç—å (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å) –∑–Ω–∞—á–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
//–Ω–∞ –≤—Ö–æ–¥: –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏ –µ—ë –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
{
	for (int i = 0; i < vector_names.size(); ++i)
		if ( vector_names[i].constant && vector_names[i].name == s )
			error ("–ø–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É ( Symbol_table::set() )");
		
		else if ( vector_names[i].name == s ) {
			vector_names[i].value = d;
			return;
		}
	
	error ("–ø–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–µ–æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π ( Symbol_table::set() )");
}

bool Symbol_table::is_declared(string s)
//–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
//–Ω–∞ –≤—Ö–æ–¥: –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
//–Ω–∞ –≤—ã—Ö–æ–¥–µ: true - –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç / false - –µ—Å–ª–∏ –Ω–µ—Ç
{
	for (int i = 0; i < vector_names.size(); ++i)
		if ( vector_names[i].name == s )	return true;
	
	return false;
}

void Symbol_table::define(string name, double d, bool cnst)
//–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π —Ä–∞–Ω–µ–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π/–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ –º–∞—Å—Å–∏–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
//–Ω–∞ –≤—Ö–æ–¥: –∏–º—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, –µ—ë –∑–Ω–∞—á–µ–Ω–∏–µ –∏ —è–≤-—Å—è –ª–∏ –æ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ–π –∏–ª–∏ –Ω–µ—Ç (true - –µ—Å–ª–∏ –¥–∞)
{
	//–ï—Å–ª–∏ —Ç–∞–∫–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π/–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –º–∞—Å—Å–∏–≤–µ
	if ( is_declared(name) == false )
		vector_names.push_back(Variable(name, d, cnst));
	
	//–ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç..
	else
		error ("–ø–æ–ø—ã—Ç–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π ( Symbol_table::define() )"); //..–æ—à–∏–±–∫–∞
		//set(string name, double d); //..–∏–∑–º–µ–Ω—è–µ–º –µ—ë –∑–Ω–∞—á–µ–Ω–∏–µ
}

//------------------------------------------------------------------------------

Token_stream ts; //–æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å —á–ª–µ–Ω–∞–º–∏ —Ñ-—Ü–∏–∏ ignore(), get() –∏ putback()
Symbol_table var_table; //–æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏

//------------------------------------------------------------------------------

double pow_proc(double num)
//–≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–µ–≥–æ —á–∏—Å–ª–∞ –≤ —Å—Ç–µ–ø–µ–Ω—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∞–∫–æ–≤—ã—Ö —Ä-—Ç–∞—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
//–ª–∏–±–æ –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ  
{
	double pow_num = primary();
	
	//pow_num < -323 - –±—É–¥–µ—Ç —Ä–∞–≤–Ω–æ 0, –ø—Ä–∏ -323 –∏ –±–æ–ª—å—à–µ –¥–æ -318 - –∑–Ω–∞—á–µ–Ω–∏–µ –∏—Å–∫–∞–∂–∞–µ—Ç—Å—è
	if ( pow_num > 308 || pow_num < -323 )
		error ("–ø—Ä–∏ –≤–æ–∑–≤–µ–¥–µ–Ω–∏–∏ –≤ —Å—Ç–µ–ø–µ–Ω—å —á–∏—Å–ª–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω DOUBLE ( pow_proc() )");
	else if (pow_num != int(pow_num))
		error ("–∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç–µ–ø–µ–Ω–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¶–ï–õ–´–ú —á–∏—Å–ª–æ–º ( pow_proc() )");
	
	pow_num = pow(num,pow_num);
	
	if ( isinf(pow_num) )
		error ("–ø—Ä–∏ –≤–æ–∑–≤–µ–¥–µ–Ω–∏–∏ –≤ —Å—Ç–µ–ø–µ–Ω—å —á–∏—Å–ª–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω DOUBLE ( pow_proc() )");
	
	return post_oper(pow_num); //–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
	/*–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Ç—É—Ç –∫—Ä–æ–µ—Ç—Å—è –ø—Ä–æ–±–ª–µ–º–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ –Ω–∞–ø—Ä–∏–º–µ—Ä 2 ^2 ^2+1 - —Ç.–µ. –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Å–∞–º–æ–π —Å—Ç–µ–ø–µ–Ω–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
	 * —É–∫–∞–∑—ã–≤–∞—é—â–µ–µ —Å—Ç–µ–ø–µ–Ω—å —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–∫—Ä—ã–≤–∞—Ç—å –≤ —Å–∫–æ–±–∫–∏ –∏–Ω–∞—á–µ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—ã—à–µ –±—É–¥–µ—Ç –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å—Å—è –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–æ:
	 * 2 ^2 ^2+1 == ( (2^2)^2 ) + 1*/
}

double factorial(double num) //–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞. –ù–∞ –≤—Ö–æ–¥ —Ç–æ–ª—å–∫–æ —Ü–µ–ª—ã–µ –ø–æ–ª–æ–∂–∏—Ç. —á–∏—Å–ª–∞
{
	if (num - int(num) != 0)
		error ("—Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç –¶–ï–õ–û–ì–û —á–∏—Å–ª–∞ ( factorial() )");
	else if (num == 0)
		return 1;	 //–§–∞–∫—Ç–æ—Ä–∏–∞–ª –Ω—É–ª—è —Ä–∞–≤–µ–Ω –µ–¥–∏–Ω–∏—Ü–µ
	else if (num < 0)
		error ("—Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–û–ì–û —á–∏—Å–ª–∞ ( factorial() )");
	
	
	double answer = 1;
	for (double i = 1; i <= num; ++i)
	{
		answer *= i;
		
		//–ï—Å–ª–∏ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞ –æ—Ç–≤–µ—Ç —Ä–∞–≤–µ–Ω inf –∏–ª–∏ -inf (+-–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å)
		if ( isinf(answer) )
			error ("–ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞ —á–∏—Å–ª–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –¥–∏–∞–ø–∞–∑–æ–Ω DOUBLE ( factorial() )");
	}
	
	 //–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è, —Ç.–∫. –∑–∞ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–æ–º –º–æ–∂–µ—Ç —Å—Ç–æ—è—Ç—å –µ—â—ë –≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –æ–ø–µ—Ä–∞—Ç–æ—Ä –∏–ª–∏ —Å–∏–º–≤–æ–ª
	return post_oper(answer);
}

double post_oper(double left)
//–ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–¥—ë—Ç –ª–∏ –¥–∞–ª—å—à–µ –∫–∞–∫–æ–π-–ª–∏–±–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä, —Ç.–µ. –∑–∞–≤–µ—Ä—à–µ–Ω–æ –ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
//–ï—Å–ª–∏ –≤—Å—ë –≤–µ—Ä–Ω–æ, –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–µ–∫—Å–µ–º—É –∫–∞–∫ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –≤—ã–∑—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
//–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª –∏–ª–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–Ω—å
{
	Token t = ts.get();
	
	switch (t.kind)
	{
		case POW: //—Å–∏–º–≤–æ–ª '^' –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–µ–Ω—å
			return pow_proc(left); //–ü—Ä–æ–±—É–µ–º –≤–æ–∑–≤–µ—Å—Ç–∏ –≤ —Å—Ç–µ–ø–µ–Ω—å
		
		case '!': //—Å–∏–º–≤–æ–ª '!' –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞
			return factorial(left); //–ü—Ä–æ–±—É–µ–º –≤—ã—á–∏—Å–ª–∏—Ç—å —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª —á–∏—Å–ª–∞
		
		case PRINT:
		case ')': case '}': case '+': case '-': case '*': case '/': case '%':
			cin.unget();
			//ts.putback(t); //–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∏–º–≤–æ–ª –≤ –ø–æ—Ç–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤, –∏–Ω–∞—á–µ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è
			return left;
			
		default:
			error ("–æ–∂–∏–¥–∞–ª—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä (<–Ω–∞–∂–∞—Ç–∏–µ Enter>, +, -, *, /, %, !, ^) ( post_oper() )");
	}
}

//------------------------------------------------------------------------------

//–æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–∏—Å–µ–ª, –¥–≤—É—Ö –≤–∏–¥–æ–≤ —Å–∫–æ–±–æ–∫ –∏ —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞
double primary()
{
	Token t = ts.get();
	
	switch (t.kind)
	{
		case '(':	//—Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é '(' –≤—ã—Ä–∞–∂–µ–Ω–∏–µ ')'
		{
			double d = expression();
			t = ts.get();

			if (t.kind != ')')
				error ("–æ–∂–∏–¥–∞–ª–∞—Å—å –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ - ')' ( primary() )");
			
			return post_oper(d);
		}
		
		case '{':	//—Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é '{' '(' –≤—ã—Ä–∞–∂–µ–Ω–∏–µ ')' '}'
		{
			string str = " ";
			getline(cin, str);
			cin.clear();
			
			//–ü–æ–∏—Å–∫ –∫—Ä—É–≥–ª–æ–π –æ—Ç–∫—Ä—ã–≤–∞—é—â–µ–π —Å–∫–æ–±–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ–∏–≥—É—Ä–Ω—ã—Ö
			//(–Ω–∞–ª–∏—á–∏–µ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç primary() —á–µ—Ä–µ–∑ –≤—ã–∑–æ–≤ 'double d = expression();')
			for (int i = 0; i < str.size(); ++i) {
				if (str[i] == '(')
					break;
				else if (i == str.size()-1)
					error ("–æ–∂–∏–¥–∞–ª–æ—Å—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ '(' –∏ ')' –≤–Ω—É—Ç—Ä–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ '{' –∏ '}' ( primary() )");
			}
			
			//–ù–∞—á–∏–Ω–∞—è —Å –∫–æ–Ω—Ü–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å—é —Å—Ç—Ä–æ–∫—É –≤ –ø–æ—Ç–æ–∫ –≤–≤–æ–¥–∞
			for (int i = str.size()-1; i >= 0; --i)
				cin.putback(str[i]); 
			
			double d = expression();
			t = ts.get();

			if (t.kind != '}')
				error ("–æ–∂–∏–¥–∞–ª–∞—Å—å –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ - '}' ( primary() )");
			
			return post_oper(d);
		}
		
		case NUMBER:			//—Å–∏–º–≤–æ–ª '8' –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –æ–±—ä–µ–∫—Ç —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º
		{
			double d = t.value; //–ø–æ–ª—É—á–∞–µ–º —Å–∞–º–æ —á–∏—Å–ª–æ
			return post_oper(d);
		}
		
		case '-': //–ü–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ
			return post_oper(- primary());
		case '+':
			return post_oper(primary());
		
		case SQRT:
		{
			t = ts.get();
			if (t.kind != '(')
				error ("–ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ 'sqrt' –æ–∂–∏–¥–∞–ª–∞—Å—å –æ—Ç–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ - '(' ( primary() )");
			
			double d = expression(); //–ø–æ–ª—É—á–∞–µ–º –∫–æ–Ω–µ—á–Ω–æ–µ —á–∏—Å–ª–æ –≤ —Å–∫–æ–±–∫–∞—Ö
			if (d < 0)
				error ("–∫–æ—Ä–µ–Ω—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–û–ì–û —á–∏—Å–ª–∞ ( primary() )");
			
			t = ts.get();
			if (t.kind != ')')
				error ("–æ–∂–∏–¥–∞–ª–∞—Å—å –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ - ')' ( primary() )");
			
			return post_oper(sqrt(d));
		}
		
		case VARIABLE: { //—Å–∏–º–≤–æ–ª 'a' –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
			string strname = t.name;
			
			t = ts.get();
			if (t.kind == '=') {//–ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
				double d = expression(); //–ø–æ–ª—É—á–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
				
				//–ø—ã—Ç–∞–µ–º—Å—è –∏–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ (–æ—à–∏–±–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç —Ç–∞–∫–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏–ª–∏ –µ—Å–ª–∏ —ç—Ç–æ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞)
				var_table.set(strname, d);
				return d;
			}
			
			else { //–ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ —Å—Ç—Ä–æ–∫–µ —Å –µ—ë –∏–º–µ–Ω–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è—Ö
				ts.putback(t);
				return post_oper(var_table.get(strname));
			}
		}
		
		default:
			error ("–æ–∂–∏–¥–∞–ª–æ—Å—å –ø–µ—Ä–≤–∏—á–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ ( primary() )");
	}
}

//------------------------------------------------------------------------------

//–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ *, / –∏ %
double term()
{
	double left = primary(); //—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –≤—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–≤–∏—á–Ω–æ–µ_–≤—ã—Ä–∞–∂–µ–Ω–∏–µ

	while (true) {
		Token t = ts.get();  //–ø–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥. –æ–±—ä–µ–∫—Ç token –∏–∑ –ø–æ—Ç–æ–∫–∞ token'–æ–≤
		switch (t.kind)
		{
			case '*':
				left *= primary(); //–≤—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–≤–∏—á–Ω–æ–µ_–≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏ —É–º–Ω–æ–∂–∞–µ–º
				break;
			case '/':
			{
				double d = primary();
				if (d == 0)		error ("–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω—É–ª—å ( term() )");
				
				left /= d; //–≤—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–≤–∏—á–Ω–æ–µ_–≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏ –¥–µ–ª–∏–º
				break;
			}
			case '%':
			{
				double d = primary();
				if (d == 0)		error ("–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω—É–ª—å ( term() )");
				
				left = fmod(left,d);
				/* –§-—Ü–∏—è –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è –æ—Å—Ç–∞—Ç–æ–∫ –æ—Ç –¥–µ–ª–µ–Ω–∏—è
				–¥–∞–∂–µ –ø—Ä–∏ –¥–µ–ª–µ–Ω–∏–∏ —á–∏—Å–µ–ª –≤ –¥—Ä–æ–±–Ω–æ–π —á–∞—Å—Ç—å—é, –Ω–∞–ø—Ä–∏–º–µ—Ä:
					6.7 % 3.3 = 6.7 - 3.3 * int(6.7/3.3) = 0.1
				*/
				break;
			}
			
			default:
				ts.putback(t);	 //–≤–æ–∑–≤—Ä–∞—â–∞–µ–º t –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–æ—Ç–æ–∫ token'–æ–≤
				return left;
		}
	}
}

//------------------------------------------------------------------------------

//–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ + –∏ -
double expression()
{
	double left = term();	  //—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –≤—ã—á–∏—Å–ª—è–µ–º Term

	while (true) {
		Token t = ts.get();   //–ø–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥. –æ–±—ä–µ–∫—Ç Token –∏–∑ –ø–æ—Ç–æ–∫–∞ Token'–æ–≤
		switch (t.kind)
		{
			case '+':
				left += term();	//–≤—ã—á–∏—Å–ª—è–µ–º Term –∏ –ø—Ä–∏–±–∞–≤–ª—è–µ–º
				break;
			case '-':
				left -= term();	//–≤—ã—á–∏—Å–ª—è–µ–º Term –∏ –æ—Ç–Ω–∏–º–∞–µ–º
				break;
			
			default:
				ts.putback(t);	 //–≤–æ–∑–≤—Ä–∞—â–∞–µ–º t –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–æ—Ç–æ–∫ token'–æ–≤
				return left;	   //–Ω–∞–∫–æ–Ω–µ—Ü: –±–æ–ª—å—à–µ –Ω–µ—Ç + –∏–ª–∏ -: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç
		}
	}
}

//------------------------------------------------------------------------------

double declaration(bool cnst)
//–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞ –ø—Ä–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π;
//–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π —Ä–∞–Ω–µ–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –≤ –º–∞—Å—Å–∏–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
//–ù–∞ –≤—Ö–æ–¥ - —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ–π (true –µ—Å–ª–∏ –¥–∞)
{
	Token t = ts.get();
	
	if (t.kind != 'a')
		error ("–æ–∂–∏–¥–∞–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π/–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ( declaration() )");
	
	else if (t.name == HELPKEY || t.name == QUITKEY || t.name == SQRTKEY)
		error ("–∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π/–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –Ω–µ –º–æ–∂–µ—Ç —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –∫–æ–º–∞–Ω–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã  ( declaration() )");
	
	else if (var_table.is_declared(t.name))
		error ("–ø–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π/–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ( declaration() )");
	
	
	string name = t.name;
	
	t = ts.get();
	if (t.kind != '=')
		error ("–ø—Ä–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø—Ä–æ–ø—É—â–µ–Ω —Å–∏–º–≤–æ–ª '=' ( declaration() )");
	
	double d = expression();
	var_table.define(name, d, cnst);
	
	return d;
}

//–û–ø—Ä–µ–¥–µ–ª—è–µ–º —á—Ç–æ –ø–æ–¥–∞–ª –Ω–∞ –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - 
//–æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–ª–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
double statement()
{
	Token t = ts.get();
	switch (t.kind) {
		case LET: //–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ–±—ä—è–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
			return declaration(false);
			
		 case CONSTANT: //–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ–±—ä—è–≤–∏—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É
			return declaration(true);
			
		default: //–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª –¥—Ä—É–≥—É—é –æ–ø–µ—Ä–∞—Ü–∏—é (–≤—ã—á–∏—Å–ª–µ–Ω–∏—è)
			ts.putback(t); //–≤–æ–∑–≤—Ä–∞—â–∞–µ–º t –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–æ—Ç–æ–∫ token'–æ–≤
			return expression();
	}
}

void calculate() //–¶–∏–∫–ª –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è
{
	while (cin)
	try 
	{
		double res = 0;
		
		cout << PROMPT;
		Token t = ts.get();
		
		while (t.kind == PRINT)		t = ts.get();
		
		//–ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ 'quit' - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –≤—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã
		if (t.kind == QUIT)				return;
		
		//–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ñ-—Ü–∏–∏ calculate() –≤—ã–≤–æ–¥—è—â–µ–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏ –≤–Ω–æ–≤—å –∑–∞–ø—É—Å–∫–∞—é—â–µ–µ —Ä–∞—Å—á—ë—Ç—ã
		else if (t.kind == HELP)		error (HELPKEY);
		
		//–≤—ã–≤–æ–¥ –≤—Å–µ—Ö —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç
		else if (t.kind == TABLEOUT)	error (TABLEOUTKEY);
		
		ts.putback(t);
		
		res = statement();
		cout << RESULT << res << "\n\n"; //endl
	}
	
	catch (exception& e) { //–î–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø—Ä–æ–≥—Ä–∞–º–º–æ–π
		string str = e.what();
		
		if ( str == HELPKEY )		cerr << HELP_INSTR;		//–í–´–í–û–î –?–ù–°–¢–†–£–ö–¶–?–?
		
		else if ( str == TABLEOUTKEY )	var_table.table_out();	//–í—ã–≤–æ–¥ –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö/–∫–æ–Ω—Å—Ç–∞–Ω—Ç
		
		else
			cerr << "–û—à–∏–±–∫–∞ ( calculate() ): " << str << "\n\n";
		
		getline(cin, str);
		cin.clear();
		//ts.ignore(PRINT);
	}
}

//------------------------------------------------------------------------------

int main()
try
{
	cout << "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä 2022 –ø–æ –ë—å—è—Ä–Ω–µ –°—Ç—Ä–∞—É—Å—Ç—Ä—É–ø—É.\n\n"
			"–ü–æ—Å–ª–µ –∑–Ω–∞–∫–∞ '>' –≤–≤–æ–¥–∏—Ç–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ß–ò–°–õ–û –û–ü–ï–†–ê–¢–û–† –ß–ò–°–õ–û. "
			"–ß–∏—Å–ª–∞ –º–æ–≥—É—Ç –±—ã—Ç—å —Å –ª—é–±—ã–º –∑–Ω–∞–∫–æ–º, —Ü–µ–ª—ã–º–∏ –∏ —Å –¥–µ—Å—è—Ç–∏—á–Ω–æ–π —á–∞—Å—Ç—å—é ("
			"–¢–û–ß–ö–ê - –¥–µ—Å—è—Ç–∏—á–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å).\n"
			"–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–≤–æ–¥–∞ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è) –Ω–∞–∂–º–∏—Ç–µ –∫–ª–∞–≤–∏—à—É ENTER.\n\n"
			"   help - –≤—ã–∑–æ–≤ —Å–ø—Ä–∞–≤–∫–∏\n   quit - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã—Ö–æ–¥–∞\n\n"; //–ü–†–ò–í–ï–¢–°–¢–í–ò–ï
	
	var_table.define("pi", 3.1415926535, true);
	var_table.define("e", 2.7182818284, true);
	var_table.define("k", 1000, true);
	
	calculate();
	
	keep_window_open("~~");
	return 0;
}

//–ü—Ä–∏ –≤–≤–æ–¥–µ CTRL+Z –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤ —Å–≤–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ 
//–≤–æ–ø—Ä–æ—Å—É —Ö–æ—á–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É
catch (CTRL_Z_throw) { 
	string str;
	getline(cin, str);
	cin.clear();
	
	if (Y_or_N("–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É?"))	return 1;
	else								calculate();
}

catch (exception& e) { //–î–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø—Ä–æ–≥—Ä–∞–º–º–æ–π
	string str;
	getline(cin, str);
	cin.clear();
	
	cerr << "–û—à–∏–±–∫–∞ ( main() ): " << e.what() << '\n';
	
	if (Y_or_N("–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É?"))	return 1000;
	else								calculate();
}

catch (...) { //–î–ª—è –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
	string str;
	getline(cin, str);
	cin.clear();
	
	cerr << "–£–ø—Å! –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ! ( main() )\n";
	
	if (Y_or_N("–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É?"))	return 1001;
	else								calculate();
}

//------------------------------------------------------------------------------
